{
  "version": 3,
  "sources": ["../src/utils/plugin-version.ts", "../src/config/constants.ts", "../src/utils/logger.ts", "../src/utils/fs-utils.ts", "../src/utils/log-rotation.ts"],
  "sourcesContent": [
    "/**\n * Plugin version utilities\n *\n * Reads version from plugin.json manifest and checks for updates\n */\n\nimport { readFileSync } from \"node:fs\";\nimport { join } from \"node:path\";\nimport {\n  CLAUDE_INSTALL_DIR,\n  MARKETPLACE_PLUGIN_JSON_URL,\n  VERSION_CHECK_TIMEOUT_MS,\n} from \"../config/constants.js\";\nimport { logger } from \"./logger.js\";\n\n/**\n * Structure of plugin.json from marketplace repository\n */\nexport interface MarketplacePluginJson {\n  version: string;\n  name?: string;\n  description?: string;\n  [key: string]: unknown; // Allow additional fields\n}\n\n/**\n * Result of version comparison\n */\nexport type VersionComparisonResult = \"newer\" | \"same\" | \"older\";\n\n/**\n * Result of update check operation\n */\nexport interface UpdateCheckResult {\n  updateAvailable: boolean;\n  currentVersion: string;\n  latestVersion: string;\n  error?: string;\n}\n\n/**\n * Get the current plugin version from the marketplace plugin.json\n * @returns Plugin version string (e.g., \"0.0.7\") or \"unknown\" if unable to read\n */\nexport function getPluginVersion(): string {\n  try {\n    // Claude reads the version from the marketplace plugin.json\n    const marketplacePluginPath = join(\n      CLAUDE_INSTALL_DIR,\n      \"plugins\",\n      \"marketplaces\",\n      \"zest-marketplace\",\n      \"zest\",\n      \".claude-plugin\",\n      \"plugin.json\",\n    );\n\n    const pluginJson = JSON.parse(readFileSync(marketplacePluginPath, \"utf-8\"));\n\n    if (pluginJson.version && typeof pluginJson.version === \"string\") {\n      logger.debug(\"Read plugin version from marketplace plugin.json\", {\n        version: pluginJson.version,\n      });\n      return pluginJson.version;\n    }\n\n    logger.warn(\"Version field not found in marketplace plugin.json\");\n    return \"unknown\";\n  } catch (error) {\n    logger.warn(\"Failed to read plugin version from marketplace plugin.json\", error);\n    return \"unknown\";\n  }\n}\n\n/**\n * Fetch the latest plugin version from the marketplace repository\n * @returns Promise that resolves to version string (e.g., \"0.0.41\")\n * @throws Error if network request fails, times out, or response is malformed\n */\nexport async function fetchMarketplaceVersion(): Promise<string> {\n  logger.info(\"Fetching latest plugin version from marketplace\", {\n    url: MARKETPLACE_PLUGIN_JSON_URL,\n  });\n\n  // Create AbortController for timeout\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => {\n    controller.abort();\n    logger.warn(\"Marketplace version fetch timed out\", {\n      timeout_ms: VERSION_CHECK_TIMEOUT_MS,\n    });\n  }, VERSION_CHECK_TIMEOUT_MS);\n\n  try {\n    // Fetch plugin.json from marketplace\n    const response = await fetch(MARKETPLACE_PLUGIN_JSON_URL, {\n      signal: controller.signal,\n      headers: {\n        Accept: \"application/json\",\n        \"User-Agent\": \"zest-claude-plugin\",\n      },\n    });\n\n    // Check HTTP status\n    if (!response.ok) {\n      const error = new Error(\n        `Marketplace request failed: HTTP ${response.status} ${response.statusText}`,\n      );\n      logger.error(\"Failed to fetch marketplace version - HTTP error\", {\n        status: response.status,\n        statusText: response.statusText,\n        url: MARKETPLACE_PLUGIN_JSON_URL,\n      });\n      throw error;\n    }\n\n    // Parse JSON response\n    const data = (await response.json()) as MarketplacePluginJson;\n\n    // Validate version field exists\n    if (!data.version || typeof data.version !== \"string\") {\n      const error = new Error(\"Marketplace plugin.json missing or invalid version field\");\n      logger.error(\"Invalid marketplace plugin.json structure\", {\n        hasVersion: !!data.version,\n        versionType: typeof data.version,\n      });\n      throw error;\n    }\n\n    logger.info(\"Successfully fetched marketplace version\", {\n      version: data.version,\n    });\n\n    return data.version;\n  } catch (error) {\n    // Handle specific error types\n    if (error instanceof Error) {\n      if (error.name === \"AbortError\") {\n        throw new Error(`Marketplace version check timed out after ${VERSION_CHECK_TIMEOUT_MS}ms`);\n      }\n      // Re-throw other errors with context\n      throw error;\n    }\n    // Handle non-Error exceptions\n    throw new Error(`Unexpected error fetching marketplace version: ${error}`);\n  } finally {\n    // Clean up timeout\n    clearTimeout(timeoutId);\n  }\n}\n\n/**\n * Parse a semantic version string into components\n * @param version - Version string (e.g., \"0.0.8\" or \"1.2.3-beta\")\n * @returns Object with major, minor, patch numbers, or null if malformed\n */\nfunction parseVersion(version: string): {\n  major: number;\n  minor: number;\n  patch: number;\n} | null {\n  // Remove leading 'v' if present\n  const cleanVersion = version.startsWith(\"v\") ? version.slice(1) : version;\n\n  // Extract base version (before any pre-release tag like \"-beta\")\n  const baseVersion = cleanVersion.split(\"-\")[0];\n\n  // Split into parts and parse as integers\n  const parts = baseVersion.split(\".\");\n\n  if (parts.length < 1 || parts.length > 3) {\n    return null;\n  }\n\n  const major = Number.parseInt(parts[0], 10);\n  const minor = parts.length >= 2 ? Number.parseInt(parts[1], 10) : 0;\n  const patch = parts.length >= 3 ? Number.parseInt(parts[2], 10) : 0;\n\n  // Check if any part is NaN\n  if (Number.isNaN(major) || Number.isNaN(minor) || Number.isNaN(patch)) {\n    return null;\n  }\n\n  // Validate ranges - reject negative numbers\n  if (major < 0 || minor < 0 || patch < 0) {\n    return null;\n  }\n\n  // Validate ranges - reject unreasonably large version numbers (likely malformed)\n  if (major > 9999 || minor > 9999 || patch > 9999) {\n    return null;\n  }\n\n  return { major, minor, patch };\n}\n\n/**\n * Compare two semantic version strings\n * @param currentVersion - Current installed version (e.g., \"0.0.1\")\n * @param latestVersion - Latest available version (e.g., \"0.0.8\")\n * @returns \"newer\" if latest > current, \"same\" if equal, \"older\" if latest < current\n *\n * @example\n * compareVersions(\"0.0.1\", \"0.0.8\") // returns \"newer\"\n * compareVersions(\"0.0.8\", \"0.0.8\") // returns \"same\"\n * compareVersions(\"0.0.10\", \"0.0.8\") // returns \"older\"\n * compareVersions(\"0.1.0\", \"0.0.9\") // returns \"newer\"\n */\nexport function compareVersions(\n  currentVersion: string,\n  latestVersion: string,\n): VersionComparisonResult {\n  logger.debug(\"Comparing versions\", {\n    current: currentVersion,\n    latest: latestVersion,\n  });\n\n  // Parse both versions\n  const current = parseVersion(currentVersion);\n  const latest = parseVersion(latestVersion);\n\n  // Handle malformed versions\n  if (!current || !latest) {\n    logger.warn(\"Unable to compare versions - malformed version string\", {\n      current: currentVersion,\n      latest: latestVersion,\n      currentParsed: current,\n      latestParsed: latest,\n    });\n    // If we can't parse, treat as \"same\" to avoid false notifications\n    return \"same\";\n  }\n\n  // Compare major version\n  if (latest.major > current.major) {\n    return \"newer\";\n  }\n  if (latest.major < current.major) {\n    return \"older\";\n  }\n\n  // Major versions equal, compare minor version\n  if (latest.minor > current.minor) {\n    return \"newer\";\n  }\n  if (latest.minor < current.minor) {\n    return \"older\";\n  }\n\n  // Major and minor equal, compare patch version\n  if (latest.patch > current.patch) {\n    return \"newer\";\n  }\n  if (latest.patch < current.patch) {\n    return \"older\";\n  }\n\n  // All components equal\n  return \"same\";\n}\n\n/**\n * Check if a plugin update is available\n *\n * Orchestrates the full version check workflow:\n * 1. Gets current installed version from local plugin.json\n * 2. Fetches latest version from marketplace repository\n * 3. Compares versions to determine if update is available\n *\n * @returns Promise that resolves to UpdateCheckResult with status and version info\n *\n * @example\n * const result = await checkForUpdates();\n * if (result.updateAvailable) {\n *   console.log(`Update available: ${result.currentVersion} â†’ ${result.latestVersion}`);\n * }\n */\nexport async function checkForUpdates(): Promise<UpdateCheckResult> {\n  logger.info(\"Starting plugin update check\");\n\n  try {\n    // Step 1: Get current installed version\n    const currentVersion = getPluginVersion();\n\n    // Handle case where we can't read local version\n    if (currentVersion === \"unknown\") {\n      const error = \"Unable to determine current plugin version\";\n      logger.warn(error);\n      return {\n        updateAvailable: false,\n        currentVersion: \"unknown\",\n        latestVersion: \"unknown\",\n        error,\n      };\n    }\n\n    logger.info(\"Current plugin version\", { version: currentVersion });\n\n    // Step 2: Fetch latest version from marketplace\n    let latestVersion: string;\n    try {\n      latestVersion = await fetchMarketplaceVersion();\n    } catch (error) {\n      // Network or parsing error - return gracefully\n      const errorMessage = error instanceof Error ? error.message : String(error);\n      logger.warn(\"Failed to fetch marketplace version\", { error: errorMessage });\n      return {\n        updateAvailable: false,\n        currentVersion,\n        latestVersion: \"unknown\",\n        error: errorMessage,\n      };\n    }\n\n    // Step 3: Compare versions\n    const comparison = compareVersions(currentVersion, latestVersion);\n\n    // Determine if update is available\n    const updateAvailable = comparison === \"newer\";\n\n    logger.info(\"Version check complete\", {\n      currentVersion,\n      latestVersion,\n      comparison,\n      updateAvailable,\n    });\n\n    return {\n      updateAvailable,\n      currentVersion,\n      latestVersion,\n    };\n  } catch (error) {\n    // Catch any unexpected errors in the orchestration\n    const errorMessage = error instanceof Error ? error.message : String(error);\n    logger.error(\"Unexpected error during version check\", { error: errorMessage });\n\n    return {\n      updateAvailable: false,\n      currentVersion: \"unknown\",\n      latestVersion: \"unknown\",\n      error: `Version check failed: ${errorMessage}`,\n    };\n  }\n}\n",
    "/**\n * Application constants and configuration values\n */\n\nimport { homedir } from \"node:os\";\nimport { join } from \"node:path\";\n\n// Claude Code directories\n// Respects CLAUDE_INSTALL_PATH environment variable for non-standard installations\nexport const CLAUDE_INSTALL_DIR = process.env.CLAUDE_INSTALL_PATH || join(homedir(), \".claude\");\n\n// Claude Code replaces \"/\", \"\\\", \":\", \".\", \"_\" and whitespace with \"-\" in project directory names\nexport const CLAUDE_DIR_SEPARATOR_PATTERN = /[\\\\/:.\\s_]/g;\nexport const CLAUDE_PROJECTS_DIR = join(CLAUDE_INSTALL_DIR, \"projects\");\nexport const CLAUDE_SETTINGS_FILE = join(CLAUDE_INSTALL_DIR, \"settings.json\");\n\n// Base directories\nexport const CLAUDE_ZEST_DIR = join(CLAUDE_INSTALL_DIR, \"..\", \".claude-zest\");\nexport const QUEUE_DIR = join(CLAUDE_ZEST_DIR, \"queue\");\nexport const LOGS_DIR = join(CLAUDE_ZEST_DIR, \"logs\");\nexport const STATE_DIR = join(CLAUDE_ZEST_DIR, \"state\");\nexport const DELETION_CACHE_DIR = join(CLAUDE_ZEST_DIR, \"cache\", \"deletions\");\n\n// File paths\nexport const SESSION_FILE = join(CLAUDE_ZEST_DIR, \"session.json\"); // Auth session + workspace info\nexport const SETTINGS_FILE = join(CLAUDE_ZEST_DIR, \"settings.json\"); // User preferences\nexport const DAEMON_PID_FILE = join(CLAUDE_ZEST_DIR, \"daemon.pid\");\nexport const CLAUDE_INSTANCES_FILE = join(CLAUDE_ZEST_DIR, \"claude-instances.json\"); // Tracked Claude Code instance PIDs\nexport const STATUSLINE_SCRIPT_PATH = join(CLAUDE_ZEST_DIR, \"statusline.mjs\"); // Status line script (.mjs for ESM support)\nexport const STATUS_CACHE_FILE = join(CLAUDE_ZEST_DIR, \"status-cache.json\"); // Status cache for version checks and sync errors\nexport const SYNC_METRICS_FILE = join(CLAUDE_ZEST_DIR, \"sync-metrics.jsonl\"); // Rolling sync metrics for last hour stats\n\n// Queue files\nexport const EVENTS_QUEUE_FILE = join(QUEUE_DIR, \"events.jsonl\");\nexport const SESSIONS_QUEUE_FILE = join(QUEUE_DIR, \"chat-sessions.jsonl\");\nexport const MESSAGES_QUEUE_FILE = join(QUEUE_DIR, \"chat-messages.jsonl\");\n\n// Platform and source identifiers\nexport const PLATFORM = \"terminal\";\nexport const SOURCE = \"claude-code\";\nexport const CLIENT_ID = \"claude-cli\";\n\n// Sync configuration\nexport const SYNC_INTERVAL_MS = 60000; // 60 seconds\nexport const MAX_RETRY_ATTEMPTS = 3;\nexport const RETRY_BACKOFF_MS = 5000;\n\n// File locking configuration\nexport const LOCK_RETRY_MS = 50; // Retry interval when lock is held by another process\nexport const LOCK_MAX_RETRIES = 300; // Max retries (10 seconds total)\n\n// Debounce configuration (prevents duplicate hook executions)\nexport const DEBOUNCE_DIR = join(CLAUDE_ZEST_DIR, \"debounce\");\nexport const DEBOUNCE_WINDOW_MS = 500; // First-wins debounce window\nexport const DEBOUNCE_TRAILING_MS = 300; // Trailing debounce: wait after last hook before processing\n\n// Delayed extraction configuration (for PostToolUse trailing debounce)\nexport const DELAYED_EXTRACTION_INITIAL_DELAY_MS = 500; // Initial wait before checking if hooks settled\nexport const DELAYED_EXTRACTION_MAX_WAIT_MS = 10000; // Maximum total wait time\nexport const DELAYED_EXTRACTION_CHECK_INTERVAL_MS = 300; // How often to check if hooks settled\n\n// Cache configuration\nexport const DELETION_CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes\n\n// Log rotation configuration\nexport const LOG_RETENTION_DAYS = 7; // Delete log files older than 7 days\n\n// Authentication configuration\nexport const PROACTIVE_REFRESH_THRESHOLD_MS = 5 * 60 * 1000; // Proactively refresh JWT/access tokens 5 minutes before expiration\n\n// Content size limits\nexport const MAX_DIFF_SIZE_BYTES = 10 * 1024 * 1024; // 10MB\nexport const MAX_CONTENT_PREVIEW_LENGTH = 1000; // characters\nexport const MAX_SESSION_TITLE_LENGTH = 100; // characters\nexport const MIN_SESSION_TITLE_LENGTH = 3; // characters\n\n// Session quality filters\nexport const MIN_MESSAGES_PER_SESSION = 3; // Minimum messages required to upload a session\nexport const STALE_SESSION_AGE_MS = 7 * 24 * 60 * 60 * 1000; // 7 days in milliseconds\n\n// API endpoints (configured from .env at build time)\n// Values are baked into the bundle during build\nexport const WEB_APP_URL = process.env.ZEST_WEB_APP_URL || \"http://localhost:3000\";\nexport const SUPABASE_URL = process.env.ZEST_SUPABASE_URL || \"\";\nexport const SUPABASE_ANON_KEY = process.env.ZEST_SUPABASE_ANON_KEY || \"\";\n\n// PostHog analytics (configured from .env at build time)\nexport const POSTHOG_API_KEY = process.env.POSTHOG_API_KEY || \"\";\n\n// Filter patterns for commands/messages to exclude from tracking\nexport const EXCLUDED_COMMAND_PATTERNS = [\n  // Claude Code built-in commands\n  /^\\/(add-dir|agents|bashes|bug|clear|compact|config|context|cost|doctor|exit|export|help|hooks|ide|init|install-github-app|login|logout|mcp|memory|model|output-style|permissions|plugin|pr-comments|privacy-settings|release-notes|resume|review|rewind|sandbox|security-review|stats|status|statusline|terminal-setup|todos|usage|vim)\\b/i,\n\n  // Zest plugin commands (like /zest:status, /zest:login, etc.)\n  /^\\/zest[^:\\s]*:/i,\n\n  // Messages containing Zest command tags (e.g., <command-name>/zest:status</command-name>)\n  /<command-name>\\/zest[^<]*<\\/command-name>/i,\n\n  // Messages containing Zest CLI script paths (e.g., \"node .../dist/commands/sync-cli.js\")\n  /node\\s+.*\\/dist\\/commands\\/.*-cli\\.js/i,\n];\n\nexport const ZEST_SESSION_NAMESPACE = \"1b671a64-40d5-491e-99b0-da01ff1f3341\";\n\n// Version check configuration\n// If ZEST_MARKETPLACE_PLUGIN_JSON_URL is not set, version checking will be disabled\nexport const MARKETPLACE_PLUGIN_JSON_URL = process.env.ZEST_MARKETPLACE_PLUGIN_JSON_URL || \"\";\nexport const VERSION_CHECK_TIMEOUT_MS = 5000; // 5 seconds\nexport const UPDATE_CHECK_CACHE_TTL_MS = 60 * 60 * 1000; // 1 hour - how long to cache update check results\n\n// Daemon management configuration\nexport const DAEMON_FRESH_PID_THRESHOLD_MS = 2000; // 2 seconds - how recently PID file must be modified to skip restart\nexport const DAEMON_INACTIVITY_TIMEOUT_MS = 5 * 60 * 1000; // 5 minutes - auto-shutdown daemon when no Claude Code instances are running\n\n// Notification configuration\nexport const NOTIFICATION_DURATION_MS = 2 * 60 * 1000; // 2 minutes - how long notifications stay visible in statusline\nexport const FIRST_DATA_THRESHOLD_MESSAGES = 5; // Minimum messages required to show \"ready to generate standup\" notification\nexport const STANDUP_NOTIFICATION_THROTTLE_MS = 2 * 60 * 60 * 1000; // 2 hours - throttle standup notifications\n\n// Sync metrics configuration\nexport const SYNC_METRICS_RETENTION_MS = 60 * 60 * 1000; // 1 hour - how long to keep sync metrics for last-hour stats\n\n// Default standup model\nexport const DEFAULT_STANDUP_MODEL = \"anthropic/claude-opus-4-5\";\n",
    "/**\n * Logging utilities\n *\n * Handles logging to console and file system with daily log rotation.\n * Log files are named with dates (e.g., plugin-2026-01-09.log) and\n * automatically cleaned up after LOG_RETENTION_DAYS.\n */\n\nimport { appendFile } from \"node:fs/promises\";\nimport { dirname } from \"node:path\";\nimport { ensureDirectory } from \"./fs-utils.js\";\nimport { cleanupStaleLogs, getDatedLogPath } from \"./log-rotation.js\";\n\ntype LogLevel = \"debug\" | \"info\" | \"warn\" | \"error\";\n\nclass Logger {\n  private minLevel: LogLevel = \"info\";\n  private readonly logPrefix: string;\n\n  private levels: Record<LogLevel, number> = {\n    debug: 0,\n    info: 1,\n    warn: 2,\n    error: 3,\n  };\n\n  constructor(logPrefix = \"plugin\") {\n    this.logPrefix = logPrefix;\n  }\n\n  setLevel(level: LogLevel): void {\n    this.minLevel = level;\n  }\n\n  private async writeToFile(message: string): Promise<void> {\n    try {\n      // Get date-based log path (handles date rollover automatically)\n      const logFilePath = getDatedLogPath(this.logPrefix);\n      await ensureDirectory(dirname(logFilePath));\n      const timestamp = new Date().toISOString();\n      await appendFile(logFilePath, `[${timestamp}] ${message}\\n`, \"utf-8\");\n\n      // Trigger cleanup (throttled to once per hour)\n      cleanupStaleLogs(this.logPrefix);\n    } catch (error) {\n      // Silently fail - don't crash if we can't write logs\n      console.error(\"Failed to write to log file:\", error);\n    }\n  }\n\n  private shouldLog(level: LogLevel): boolean {\n    return this.levels[level] >= this.levels[this.minLevel];\n  }\n\n  debug(message: string, ...args: unknown[]): void {\n    if (this.shouldLog(\"debug\")) {\n      // Only write to file, don't clutter console\n      this.writeToFile(`DEBUG: ${message} ${args.length > 0 ? JSON.stringify(args) : \"\"}`);\n    }\n  }\n\n  info(message: string, ...args: unknown[]): void {\n    if (this.shouldLog(\"info\")) {\n      // Only write to file, don't clutter console\n      this.writeToFile(`INFO: ${message} ${args.length > 0 ? JSON.stringify(args) : \"\"}`);\n    }\n  }\n\n  warn(message: string, ...args: unknown[]): void {\n    if (this.shouldLog(\"warn\")) {\n      // Show warnings to user\n      console.warn(`[Zest:Warn] ${message}`, ...args);\n      this.writeToFile(`WARN: ${message} ${args.length > 0 ? JSON.stringify(args) : \"\"}`);\n    }\n  }\n\n  error(message: string, error?: unknown): void {\n    if (this.shouldLog(\"error\")) {\n      // Show errors to user\n      console.error(`[Zest:Error] ${message}`, error);\n      this.writeToFile(\n        `ERROR: ${message} ${error instanceof Error ? error.stack : JSON.stringify(error)}`,\n      );\n    }\n  }\n}\n\nexport const logger = new Logger();\n",
    "/**\n * Filesystem utility functions\n *\n * Shared helpers for file and directory operations\n *\n * Note: This module intentionally has no dependencies on logger.ts\n * to avoid circular dependencies (logger.ts uses ensureDirectory).\n */\n\nimport { mkdir, stat } from \"node:fs/promises\";\n\n/**\n * Sanitize a string for safe use in filenames across all platforms.\n * Replaces characters illegal in Windows filenames (\\ / : * ? \" < > |) with underscores.\n */\nexport function sanitizeForFilename(input: string): string {\n  return input.replace(/[\\\\/:*?\"<>|]/g, \"_\");\n}\n\n/**\n * Ensure directory exists, creating it if necessary\n * Creates parent directories recursively with secure permissions (mode 0o700)\n *\n * @param dirPath - Path to the directory to ensure exists\n */\nexport async function ensureDirectory(dirPath: string): Promise<void> {\n  try {\n    await stat(dirPath);\n  } catch {\n    await mkdir(dirPath, { recursive: true, mode: 0o700 });\n  }\n}\n",
    "/**\n * Log rotation utilities\n *\n * Provides date-based log file paths and automatic cleanup of stale logs.\n */\n\nimport { readdir, unlink } from \"node:fs/promises\";\nimport { join } from \"node:path\";\nimport { LOG_RETENTION_DAYS, LOGS_DIR } from \"../config/constants.js\";\nimport { ensureDirectory } from \"./fs-utils.js\";\nimport { logger } from \"./logger.js\";\n\n// Throttle cleanup to run at most once per hour\nconst CLEANUP_THROTTLE_MS = 60 * 60 * 1000; // 1 hour\nlet lastCleanupTime: Record<string, number> = {};\n\n/**\n * Get current date string in YYYY-MM-DD format (UTC)\n */\nexport function getDateString(): string {\n  return new Date().toISOString().split(\"T\")[0];\n}\n\n/**\n * Get date-based log file path\n * @param logPrefix - Prefix for the log file (e.g., \"plugin\" or \"sync\")\n * @returns Full path like ~/.claude-zest/logs/plugin-2026-01-09.log\n */\nexport function getDatedLogPath(logPrefix: string): string {\n  const dateStr = getDateString();\n  return join(LOGS_DIR, `${logPrefix}-${dateStr}.log`);\n}\n\n/**\n * Parse date from log filename\n * @param filename - Filename like \"plugin-2026-01-09.log\"\n * @param logPrefix - Prefix to match (e.g., \"plugin\")\n * @returns Date object or null if doesn't match pattern\n */\nfunction parseDateFromFilename(filename: string, logPrefix: string): Date | null {\n  const pattern = new RegExp(`^${logPrefix}-(\\\\d{4}-\\\\d{2}-\\\\d{2})\\\\.log$`);\n  const match = filename.match(pattern);\n\n  if (!match) {\n    return null;\n  }\n\n  const date = new Date(match[1] + \"T00:00:00Z\");\n  return Number.isNaN(date.getTime()) ? null : date;\n}\n\n/**\n * Clean up stale log files older than retention period\n * Throttled to run at most once per hour per logPrefix\n *\n * @param logPrefix - Prefix of logs to clean (e.g., \"plugin\" or \"sync\")\n */\nexport async function cleanupStaleLogs(logPrefix: string): Promise<void> {\n  const now = Date.now();\n  const lastCleanup = lastCleanupTime[logPrefix] || 0;\n\n  // Throttle: skip if cleaned up less than an hour ago\n  if (now - lastCleanup < CLEANUP_THROTTLE_MS) {\n    return;\n  }\n\n  lastCleanupTime[logPrefix] = now;\n\n  try {\n    await ensureDirectory(LOGS_DIR);\n    const files = await readdir(LOGS_DIR);\n    const cutoffDate = new Date(now - LOG_RETENTION_DAYS * 24 * 60 * 60 * 1000);\n\n    for (const file of files) {\n      const fileDate = parseDateFromFilename(file, logPrefix);\n\n      if (fileDate && fileDate < cutoffDate) {\n        const filePath = join(LOGS_DIR, file);\n        try {\n          await unlink(filePath);\n        } catch (error) {\n          logger.error(`Failed to delete old log file ${file}`, error);\n        }\n      }\n    }\n  } catch (error) {\n    logger.error(\"Failed to cleanup old logs\", error);\n  }\n}\n\n/**\n * Force cleanup regardless of throttle (for daemon startup)\n * @param logPrefix - Prefix of logs to clean (e.g., \"plugin\" or \"sync\")\n */\nexport async function forceCleanupStaleLogs(logPrefix: string): Promise<void> {\n  // Reset throttle to force cleanup\n  lastCleanupTime[logPrefix] = 0;\n  await cleanupStaleLogs(logPrefix);\n}\n"
  ],
  "mappings": "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",
  "debugId": "2E60756AC043011564756E2164756E21",
  "names": []
}